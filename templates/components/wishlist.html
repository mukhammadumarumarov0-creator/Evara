<section class="wishlist section--lg container">
    <div class="table__container">
      <table class="table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Stock Status</th>
            <th>Action</th>
            <th>Rename</th>
          </tr>
        </thead>
        <tbody>
          {% for w in wish_products %}
          <tr>
            <td>
              <img
                src="{{w.image.url}}"
                alt=""
                class="table__img"
              />
            </td>
            <td>
              <h3 class="table__title">
               {{w.name}}
              </h3>
              <p class="table__description">
                {{w.description}}
              </p>
            </td>
            <td>
              <span class="table__price">${{w.price}}</span>
            </td>
            <td><span class="table__stock">In Stock</span></td>
            <td><a href="{% url 'add_product' w.id %}" class="btn btn--sm">Add to Cart</a></td>
            <td><a href="{% url 'wishlist_remove' w.id %}"><i class="fi fi-rs-trash table__trash"></i></a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const wishlistButtons = document.querySelectorAll('.wishlist__btn');
    
      wishlistButtons.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
    
          const productId = btn.dataset.productId;
          if (!productId) {
            console.error('‚ùå data-product-id topilmadi');
            return;
          }
    
          try {
            const response = await fetch(`/wishlist/add/${productId}/`, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
              },
              credentials: 'same-origin'
            });
    
            if (response.status === 403) {
              console.warn('‚ö†Ô∏è Foydalanuvchi login qilmagan ‚Äî localStorage ishlatilyapti');
              addToLocalWishlist(productId);
              updateWishlistCountLocal();
              return;
            }
    
            if (!response.ok) throw new Error('Server error');
    
            const data = await response.json();
            console.log('‚ù§Ô∏è Added to wishlist:', data);
    
            const countEl = document.getElementById('wishlist_count');
            if (countEl && data.wishlist_count !== undefined) {
              countEl.textContent = data.wishlist_count;
            }
    
            btn.classList.add('added');
            setTimeout(() => btn.classList.remove('added'), 800);
    
          } catch (error) {
            console.error('‚ùå Wishlist xatolik:', error);
          }
        });
      });
    });
    
    // üç™ Django uchun csrf cookie funksiyasi
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // üß° Agar user login qilmagan bo‚Äòlsa localStorage ishlatamiz
    function addToLocalWishlist(productId) {
      let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
      if (!wishlist.includes(productId)) wishlist.push(productId);
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
    }
    
    // üî¢ localStorage dagi wishlist count ni yangilaydi
    function updateWishlistCountLocal() {
      const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
      const countEl = document.getElementById('wishlist_count');
      if (countEl) countEl.textContent = wishlist.length;}
</script>