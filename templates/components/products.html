{% load static %}

<section class="products container section">
 <p class="total__products">Siz uchun <span>{{product_count}}</span> ta mahsulot topildi !</p>
  <div class="tab__items">
    <div class="tab__item active-tab" content id="featured">
      <div class="products__container grid">
        {% if product %}
          {% for p in product %}
            {% if p.id %}
              <div class="product__item">
                <div class="product__banner">
                  <a href="{% url 'details' p.id %}" class="product__images">
                    <img src="{{ p.image.url }}" alt="{{ p.name }}" class="product__img default" />
                    <img src="{{ p.image.url }}" alt="{{ p.name }}" class="product__img hover" />
                  </a>
                  <div class="product__actions">
                    <a href="{% url 'details' p.id %}" class="action__btn" aria-label="Quick View">
                      <i class="fi fi-rs-eye"></i>

                    </a>

                    <a href="#" 
                      class="action__btn wishlist__btn" 
                      aria-label="Add to Wishlist" 
                      data-product-id="{{ p.id }}">
                      <i class="fi fi-rs-heart"></i>
                    </a>


                    <a href="#" class="action__btn" aria-label="Compare">
                      <i class="fi fi-rs-shuffle"></i>
                    </a>
                  </div>

                  {% if p.discount %}
                    <div class="product__badge light-pink">-{{ p.discount }}%</div>
                  {% endif %}
                </div>

                <div class="product__content">
                  <span class="product__category">{{ p.category }}</span>
                  <a href="{% url 'details' p.id %}">
                    <h3 class="product__title">{{ p.name }}</h3>
                  </a>
                  <div class="product__rating">
                    <i class="fi fi-rs-star"></i>
                    <i class="fi fi-rs-star"></i>
                    <i class="fi fi-rs-star"></i>
                    <i class="fi fi-rs-star"></i>
                    <i class="fi fi-rs-star"></i>
                  </div>

                  <div class="product__price flex">
                    <span class="new__price">
                      ${{ p.discount_price|default:p.price }}
                    </span>
                    {% if p.discount %}
                      <span class="old__price">${{ p.price }}</span>
                    {% endif %}
                    <a href="#" 
                    class="action__btn cart__btn" 
                    aria-label="Add To Cart" 
                    data-product-id="{{ p.id }}">
                    <i class="fi fi-rs-shopping-bag-add"></i>
                 </a>
                    </a>
                  </div>

                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-product">
              <div class="no-product-content">
                <i class="fi fi-rs-box"></i>
                <h2>Bu  hozircha mahsulot yo‚Äòq üòî</h2>
                <p>Tez orada yangi mahsulotlar qo‚Äòshiladi, qayta kirib ko‚Äòring!</p>
                <a href="/" class="back-btn">üè† Bosh sahifaga qaytish</a>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-product">
            <div class="no-product-content">
              <i class="fi fi-rs-box"></i>
              <h2>Bu yerda hozircha mahsulot yo‚Äòq üòî</h2>
              <p>Tez orada yangi mahsulotlar qo‚Äòshiladi, qayta kirib ko‚Äòring!</p>
              <a href="/" class="back-btn">üè† Bosh sahifaga qaytish</a>
            </div>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
  <!-- PAGINATION QISMI SHU ERDA -->
   <ul class="pagination">
    {% if product.has_previous %}
      <li><a href="?page={{product.page_number}}" class="pagination__link "> < </a></li>
    {% endif %}

    {% for page in product.paginator.page_range  %}
    <li><a href="?page={{page}}" class="pagination__link  {% if product.number == page %}active{% endif %}" blank>{{page}}</a></li>
    
    {% endfor %}

    {% if product.has_next %}
      <li><a href="?page={{product.next_page_number}}" class="pagination__link "> > </a></li>
    {% endif %}
     </ul>
</section>

  
<style>
  .no-product {
  grid-column: 1 / -1;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 4rem 2rem;
  background: linear-gradient(145deg, #f8f9fa, #eef2f3);
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  }
  .no-product-content {
  text-align: center;
  color: #333;
  max-width: 500px;
  }
  .no-product-content i {
  font-size: 4rem;
  color: #38bdf8;
  margin-bottom: 1rem;
  display: inline-block;
  }
  .no-product-content h2 {
  font-size: 1.6rem;
  margin-bottom: 0.5rem;
  color: #111827;
  font-weight: 600;
  }
  .no-product-content p {
  color: #6b7280;
  font-size: 1rem;
  margin-bottom: 1.5rem;
  }
  .back-btn {
  display: inline-block;
  background: #10b981;
  color: #fff;
  padding: 0.7rem 1.4rem;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 500;
  transition: background 0.3s ease, transform 0.2s ease;
  }
  .back-btn:hover {
  background: #059669;
  transform: scale(1.05);
  }
</style>



<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    const cartButtons = document.querySelectorAll('.cart__btn');
  
    cartButtons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const productId = btn.dataset.productId;
  
        try {
          const response = await fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
          });
  
          if (!response.ok) throw new Error('Server error');
          const data = await response.json();
  
          // üõí Cart count yangilash
          const countEl = document.getElementById('cart_count');
          if (countEl) countEl.textContent = data.cart_count;
  
          // Animatsiya
          btn.classList.add('added');
          setTimeout(() => btn.classList.remove('added'), 800);
  
        } catch (error) {
          console.error('‚ùå Cart xatolik:', error);
        }
      });
    });
  });
  
</script>


<script>
      document.addEventListener('DOMContentLoaded', () => {
        const wishlistButtons = document.querySelectorAll('.wishlist__btn');
      
        wishlistButtons.forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
      
            const productId = btn.dataset.productId;
            if (!productId) {
              console.error('‚ùå data-product-id topilmadi');
              return;
            }
      
            try {
              const response = await fetch(`/wishlist/add/${productId}/`, {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': getCookie('csrftoken'),
                  'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
              });
      
              if (response.status === 403) {
                console.warn('‚ö†Ô∏è Foydalanuvchi login qilmagan ‚Äî localStorage ishlatilyapti');
                addToLocalWishlist(productId);
                updateWishlistCountLocal();
                return;
              }
      
              if (!response.ok) throw new Error('Server error');
      
              const data = await response.json();
              console.log('‚ù§Ô∏è Added to wishlist:', data);
      
              const countEl = document.getElementById('wishlist_count');
              if (countEl && data.wishlist_count !== undefined) {
                countEl.textContent = data.wishlist_count;
              }
      
              btn.classList.add('added');
              setTimeout(() => btn.classList.remove('added'), 800);
      
            } catch (error) {
              console.error('‚ùå Wishlist xatolik:', error);
            }
          });
        });
      });
      
      // üç™ Django uchun csrf cookie funksiyasi
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
      // üß° Agar user login qilmagan bo‚Äòlsa localStorage ishlatamiz
      function addToLocalWishlist(productId) {
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        if (!wishlist.includes(productId)) wishlist.push(productId);
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
      }
      
      // üî¢ localStorage dagi wishlist count ni yangilaydi
      function updateWishlistCountLocal() {
        const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        const countEl = document.getElementById('wishlist_count');
        if (countEl) countEl.textContent = wishlist.length;}
</script>